<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroAmazonia - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: #2c3e50; color: white; padding: 20px; margin-bottom: 30px; border-radius: 8px; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .metric-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .metric-value { font-size: 2em; font-weight: bold; color: #2c3e50; }
        .metric-label { color: #7f8c8d; margin-top: 5px; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .refresh-btn { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        .refresh-btn:hover { background: #2980b9; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Dashboard - AgroAmazonia</h1>
            <p>MÃ©tricas de processamento de documentos</p>
            <button class="refresh-btn" onclick="loadDashboard()">Atualizar</button>
        </div>

        <div id="loading" class="loading">Carregando mÃ©tricas...</div>
        
        <div id="dashboard" style="display: none;">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="totalToday">0</div>
                    <div class="metric-label">Processos Hoje</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value success" id="successToday">0</div>
                    <div class="metric-label">Sucessos Hoje</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value error" id="failedToday">0</div>
                    <div class="metric-label">Falhas Hoje</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="successRate">0%</div>
                    <div class="metric-label">Taxa de Sucesso</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgTime">0s</div>
                    <div class="metric-label">Tempo MÃ©dio</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Ãšltimos 7 Dias</h3>
                    <canvas id="weeklyChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>DistribuiÃ§Ã£o por Hora (Hoje)</h3>
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h3>Tipos de Erro</h3>
                <canvas id="errorChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://ovyt3c2b2c.execute-api.us-east-1.amazonaws.com/v1/api/v1';
        const API_KEY = 'agroamazonia_key_demo123'; // Substitua pela sua API key

        let weeklyChart, hourlyChart, errorChart;

        async function fetchMetrics() {
            const response = await fetch(`${API_BASE}/dashboard/metrics`, {
                headers: { 'x-api-key': API_KEY }
            });
            if (!response.ok) throw new Error('Erro ao buscar mÃ©tricas');
            return response.json();
        }

        function updateMetricCards(data) {
            const today = data.today || {};
            document.getElementById('totalToday').textContent = today.total_count || 0;
            document.getElementById('successToday').textContent = today.success_count || 0;
            document.getElementById('failedToday').textContent = today.failed_count || 0;
            document.getElementById('successRate').textContent = (today.success_rate || 0) + '%';
            document.getElementById('avgTime').textContent = (today.avg_processing_time || 0) + 's';
        }

        function createWeeklyChart(data) {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            const last7Days = data.last_7_days || [];
            
            if (weeklyChart) weeklyChart.destroy();
            
            weeklyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(d => d.date).reverse(),
                    datasets: [{
                        label: 'Sucessos',
                        data: last7Days.map(d => d.success).reverse(),
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Falhas',
                        data: last7Days.map(d => d.failed).reverse(),
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createHourlyChart(data) {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            const hourly = data.today?.processes_by_hour || {};
            
            if (hourlyChart) hourlyChart.destroy();
            
            const hours = Array.from({length: 24}, (_, i) => i.toString().padStart(2, '0'));
            const counts = hours.map(h => hourly[h] || 0);
            
            hourlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours.map(h => h + ':00'),
                    datasets: [{
                        label: 'Processos',
                        data: counts,
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createErrorChart(data) {
            const ctx = document.getElementById('errorChart').getContext('2d');
            const errors = data.today?.failure_reasons || {};
            
            if (errorChart) errorChart.destroy();
            
            const labels = Object.keys(errors);
            const values = Object.values(errors);
            
            if (labels.length === 0) {
                ctx.fillText('Nenhum erro hoje! ðŸŽ‰', 10, 50);
                return;
            }
            
            errorChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#e74c3c', '#f39c12', '#9b59b6', '#34495e', '#1abc9c'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        async function loadDashboard() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            
            try {
                const data = await fetchMetrics();
                
                updateMetricCards(data);
                createWeeklyChart(data);
                createHourlyChart(data);
                createErrorChart(data);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('loading').innerHTML = 
                    '<div class="error">Erro ao carregar mÃ©tricas: ' + error.message + '</div>';
            }
        }

        // Carregar dashboard ao iniciar
        loadDashboard();
        
        // Auto-refresh a cada 30 segundos
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>