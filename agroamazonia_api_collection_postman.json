{
	"info": {
		"_postman_id": "agroamazonia-api-v2",
		"name": "AgroAmazonia API - Completa",
		"description": "Collection para testar a API AgroAmazonia.\n\n**Fluxo**:\n1. Gerar URL para XML\n2. Upload do XML\n3. Gerar URLs para PDFs\n4. Upload dos PDFs\n5. Iniciar processamento\n6. Consultar resultados\n\n**Autenticação**: Rotas `/api/*` requerem `x-api-key`\n\n**URL**: https://ovyt3c2b2c.execute-api.us-east-1.amazonaws.com/v1",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "1. Fluxo Principal",
			"item": [
				{
					"name": "1.1 Gerar URL XML",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"if (!pm.collectionVariables.get('process_id')) {",
									"    const uuid = require('uuid');",
									"    pm.collectionVariables.set('process_id', uuid.v4());",
									"    console.log('✅ process_id:', pm.collectionVariables.get('process_id'));",
									"}"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200', () => pm.response.to.have.status(200));",
									"const res = pm.response.json();",
									"pm.collectionVariables.set('xml_upload_url', res.upload_url);",
									"console.log('✅ URL XML salva');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{"key": "x-api-key", "value": "{{api_key}}", "type": "text"},
							{"key": "Content-Type", "value": "application/json", "type": "text"}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"process_id\": \"{{process_id}}\",\n    \"file_name\": \"nota_fiscal.xml\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/process/presigned-url/xml",
							"host": ["{{base_url}}"],
							"path": ["api", "process", "presigned-url", "xml"]
						}
					}
				},
				{
					"name": "1.2 Upload XML",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Upload OK', () => pm.response.to.have.status(200));",
									"console.log('✅ XML enviado');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "PUT",
						"header": [{"key": "Content-Type", "value": "application/xml"}],
						"body": {
							"mode": "raw",
							"raw": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<nfeProc>\n    <NFe>\n        <infNFe>\n            <ide>\n                <nNF>2655</nNF>\n                <serie>1</serie>\n                <dhEmi>2024-01-15T10:30:00-03:00</dhEmi>\n            </ide>\n            <emit>\n                <CNPJ>12345678000190</CNPJ>\n                <xNome>Fornecedor LTDA</xNome>\n            </emit>\n            <total>\n                <ICMSTot>\n                    <vNF>15000.00</vNF>\n                </ICMSTot>\n            </total>\n        </infNFe>\n    </NFe>\n</nfeProc>"
						},
						"url": {"raw": "{{xml_upload_url}}", "host": ["{{xml_upload_url}}"]}
					}
				},
				{
					"name": "1.3 Gerar URLs PDFs",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200', () => pm.response.to.have.status(200));",
									"const res = pm.response.json();",
									"if (res.urls && res.urls.length > 0) {",
									"    pm.collectionVariables.set('doc1_url', res.urls[0].upload_url);",
									"    if (res.urls.length > 1) pm.collectionVariables.set('doc2_url', res.urls[1].upload_url);",
									"    console.log('✅ URLs PDFs salvas');",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{"key": "x-api-key", "value": "{{api_key}}", "type": "text"},
							{"key": "Content-Type", "value": "application/json"}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"process_id\": \"{{process_id}}\",\n    \"files\": [\n        {\"file_name\": \"pedido.pdf\"},\n        {\"file_name\": \"nota.pdf\"}\n    ]\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/process/presigned-url/docs",
							"host": ["{{base_url}}"],
							"path": ["api", "process", "presigned-url", "docs"]
						}
					}
				},
				{
					"name": "1.4 Upload PDF 1",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Upload OK', () => pm.response.to.have.status(200));",
									"console.log('✅ PDF 1 enviado');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "PUT",
						"header": [{"key": "Content-Type", "value": "application/pdf"}],
						"body": {
							"mode": "raw",
							"raw": "%PDF-1.4\n1 0 obj\n<</Type/Catalog/Pages 2 0 R>>endobj\n2 0 obj\n<</Type/Pages/Kids[3 0 R]/Count 1>>endobj\n3 0 obj\n<</Type/Page/Parent 2 0 R/MediaBox[0 0 612 792]/Contents 4 0 R>>endobj\n4 0 obj\n<</Length 44>>stream\nBT\n/F1 12 Tf\n100 700 Td\n(Pedido) Tj\nET\nendstream\nendobj\nxref\n0 5\ntrailer\n<</Size 5/Root 1 0 R>>\nstartxref\n200\n%%EOF"
						},
						"url": {"raw": "{{doc1_url}}", "host": ["{{doc1_url}}"]}
					}
				},
				{
					"name": "1.5 Upload PDF 2",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Upload OK', () => pm.response.to.have.status(200));",
									"console.log('✅ PDF 2 enviado');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "PUT",
						"header": [{"key": "Content-Type", "value": "application/pdf"}],
						"body": {
							"mode": "raw",
							"raw": "%PDF-1.4\n1 0 obj\n<</Type/Catalog/Pages 2 0 R>>endobj\n2 0 obj\n<</Type/Pages/Kids[3 0 R]/Count 1>>endobj\n3 0 obj\n<</Type/Page/Parent 2 0 R/MediaBox[0 0 612 792]/Contents 4 0 R>>endobj\n4 0 obj\n<</Length 40>>stream\nBT\n/F1 12 Tf\n100 700 Td\n(Nota 2655) Tj\nET\nendstream\nendobj\nxref\n0 5\ntrailer\n<</Size 5/Root 1 0 R>>\nstartxref\n200\n%%EOF"
						},
						"url": {"raw": "{{doc2_url}}", "host": ["{{doc2_url}}"]}
					}
				},
				{
					"name": "1.6 Iniciar Processamento",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Iniciado', () => pm.response.to.have.status(200));",
									"const res = pm.response.json();",
									"console.log('✅ Step Functions:', res.execution_arn);",
									"console.log('⏳ Aguarde 2-5 minutos');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{"key": "x-api-key", "value": "{{api_key}}", "type": "text"},
							{"key": "Content-Type", "value": "application/json"}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"process_id\": \"{{process_id}}\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/process/start",
							"host": ["{{base_url}}"],
							"path": ["api", "process", "start"]
						}
					}
				}
			]
		},
		{
			"name": "2. Consultas",
			"item": [
				{
					"name": "Buscar Processo",
					"request": {
						"method": "GET",
						"header": [{"key": "x-api-key", "value": "{{api_key}}", "type": "text"}],
						"url": {
							"raw": "{{base_url}}/api/process/{{process_id}}",
							"host": ["{{base_url}}"],
							"path": ["api", "process", "{{process_id}}"]
						}
					}
				},
				{
					"name": "Buscar Validações",
					"request": {
						"method": "GET",
						"header": [{"key": "x-api-key", "value": "{{api_key}}", "type": "text"}],
						"url": {
							"raw": "{{base_url}}/api/process/{{process_id}}/validations",
							"host": ["{{base_url}}"],
							"path": ["api", "process", "{{process_id}}", "validations"]
						}
					}
				},
				{
					"name": "Listar Processos",
					"request": {
						"method": "GET",
						"header": [{"key": "x-api-key", "value": "{{api_key}}", "type": "text"}],
						"url": {
							"raw": "{{base_url}}/api/process",
							"host": ["{{base_url}}"],
							"path": ["api", "process"]
						}
					}
				}
			]
		},
		{
			"name": "3. Regras",
			"item": [
				{
					"name": "Listar Regras AGROQUIMICOS",
					"request": {
						"method": "GET",
						"header": [{"key": "x-api-key", "value": "{{api_key}}", "type": "text"}],
						"url": {
							"raw": "{{base_url}}/api/rules/AGROQUIMICOS",
							"host": ["{{base_url}}"],
							"path": ["api", "rules", "AGROQUIMICOS"]
						}
					}
				},
				{
					"name": "Criar Regra",
					"request": {
						"method": "POST",
						"header": [
							{"key": "x-api-key", "value": "{{api_key}}", "type": "text"},
							{"key": "Content-Type", "value": "application/json"}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"process_type\": \"AGROQUIMICOS\",\n    \"rule_name\": \"validar_numero_nota\",\n    \"order\": 1,\n    \"enabled\": true\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/rules",
							"host": ["{{base_url}}"],
							"path": ["api", "rules"]
						}
					}
				}
			]
		},
		{
			"name": "4. Públicas",
			"item": [
				{
					"name": "Health Check",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/health",
							"host": ["{{base_url}}"],
							"path": ["health"]
						}
					}
				},
				{
					"name": "Root",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/",
							"host": ["{{base_url}}"],
							"path": [""]
						}
					}
				}
			]
		}
	],
	"variable": [
		{"key": "base_url", "value": "https://ovyt3c2b2c.execute-api.us-east-1.amazonaws.com/v1", "type": "string"},
		{"key": "api_key", "value": "agroamazonia_key_UPXsb8Hb8sjbxWBQqouzYnTL5w-V_dJx", "type": "string"},
		{"key": "process_id", "value": "", "type": "string"},
		{"key": "xml_upload_url", "value": "", "type": "string"},
		{"key": "doc1_url", "value": "", "type": "string"},
		{"key": "doc2_url", "value": "", "type": "string"}
	]
}
